From a6c87d2cdc63430143e13d09970d29e2e7f1ae9e Mon Sep 17 00:00:00 2001
From: Pietro Albini <pietro@pietroalbini.org>
Date: Sun, 8 Jan 2023 19:11:03 +0100
Subject: [PATCH 5/6] hook up vendored dependencies with the build system

---
 Cargo.lock                                   | 36 ++++++++++++++------
 Cargo.toml                                   |  8 +++++
 cve-2022-46176-deps/base64-0.13.1/Cargo.toml | 16 ---------
 cve-2022-46176-deps/hmac-0.12.1/Cargo.toml   | 23 -------------
 cve-2022-46176-deps/sha-1-0.10.1/Cargo.toml  | 14 +-------
 5 files changed, 34 insertions(+), 63 deletions(-)

diff --git a/Cargo.lock b/Cargo.lock
index dab693419..19acbfbba 100644
--- a/Cargo.lock
+++ b/Cargo.lock
@@ -194,6 +194,10 @@ dependencies = [
  "rustc-demangle",
 ]
 
+[[package]]
+name = "base64"
+version = "0.13.1"
+
 [[package]]
 name = "bitflags"
 version = "1.3.2"
@@ -292,6 +296,7 @@ version = "0.67.0"
 dependencies = [
  "anyhow",
  "atty",
+ "base64",
  "bytesize",
  "cargo-platform 0.1.2",
  "cargo-test-macro",
@@ -309,6 +314,7 @@ dependencies = [
  "git2-curl",
  "glob",
  "hex 0.4.2",
+ "hmac",
  "home",
  "humantime 2.0.1",
  "ignore",
@@ -336,6 +342,7 @@ dependencies = [
  "serde-value",
  "serde_ignored",
  "serde_json",
+ "sha-1",
  "shell-escape",
  "snapbox",
  "strip-ansi-escapes",
@@ -1004,11 +1011,12 @@ dependencies = [
 
 [[package]]
 name = "crypto-common"
-version = "0.1.2"
+version = "0.1.3"
 source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "a4600d695eb3f6ce1cd44e6e291adceb2cc3ab12f20a33777ecd0bf6eba34e06"
+checksum = "57952ca27b5e3606ff4dd79b0020231aaf9d6aa76dc05fd30137538c50bd3ce8"
 dependencies = [
  "generic-array",
+ "typenum",
 ]
 
 [[package]]
@@ -1095,12 +1103,11 @@ checksum = "524cbf6897b527295dff137cec09ecf3a05f4fddffd7dfcd1585403449e74198"
 
 [[package]]
 name = "digest"
-version = "0.10.2"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "8cb780dce4f9a8f5c087362b3a4595936b2019e7c8b30f2c3e9a7e94e6ae9837"
+version = "0.10.6"
 dependencies = [
  "block-buffer",
  "crypto-common",
+ "subtle",
 ]
 
 [[package]]
@@ -1559,8 +1566,6 @@ dependencies = [
 [[package]]
 name = "git2"
 version = "0.15.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "2994bee4a3a6a51eb90c218523be382fd7ea09b16380b9312e9dbe955ff7c7d1"
 dependencies = [
  "bitflags",
  "libc",
@@ -1676,6 +1681,13 @@ version = "0.4.2"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 checksum = "644f9158b2f133fd50f5fb3242878846d9eb792e445c893805ff0e3824006e35"
 
+[[package]]
+name = "hmac"
+version = "0.12.1"
+dependencies = [
+ "digest",
+]
+
 [[package]]
 name = "home"
 version = "0.5.3"
@@ -1964,8 +1976,6 @@ dependencies = [
 [[package]]
 name = "libgit2-sys"
 version = "0.14.0+1.5.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "47a00859c70c8a4f7218e6d1cc32875c4b55f6799445b842b0d8ed5e4c3d959b"
 dependencies = [
  "cc",
  "libc",
@@ -4745,6 +4755,10 @@ version = "0.10.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 checksum = "73473c0e59e6d5812c5dfe2a064a6444949f089e20eec9a2e5506596494e4623"
 
+[[package]]
+name = "subtle"
+version = "2.4.1"
+
 [[package]]
 name = "syn"
 version = "1.0.102"
@@ -5106,9 +5120,9 @@ dependencies = [
 
 [[package]]
 name = "typenum"
-version = "1.12.0"
+version = "1.15.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "373c8a200f9e67a0c95e62a4f52fbf80c23b4381c05a17845531982fa99e6b33"
+checksum = "dcf81ac59edc17cc8697ff311e8f5ef2d99fcbd9817b34cec66f90b6c3dfd987"
 
 [[package]]
 name = "ucd-parse"
diff --git a/Cargo.toml b/Cargo.toml
index e49fe5e2f..f6dbab771 100644
--- a/Cargo.toml
+++ b/Cargo.toml
@@ -109,5 +109,13 @@ rustc-std-workspace-core = { path = 'library/rustc-std-workspace-core' }
 rustc-std-workspace-alloc = { path = 'library/rustc-std-workspace-alloc' }
 rustc-std-workspace-std = { path = 'library/rustc-std-workspace-std' }
 
+# CVE-2022-46176 patched crates.
+git2 = { path = "cve-2022-46176-deps/git2-0.15.0" }
+libgit2-sys = { path = "cve-2022-46176-deps/libgit2-sys-0.14.0+1.5.0" }
+subtle = { path = "cve-2022-46176-deps/subtle-2.4.1" }
+base64 = { path = "cve-2022-46176-deps/base64-0.13.1" }
+hmac = { path = "cve-2022-46176-deps/hmac-0.12.1" }
+digest = { path = "cve-2022-46176-deps/digest-0.10.6" }
+
 [patch."https://github.com/rust-lang/rust-clippy"]
 clippy_lints = { path = "src/tools/clippy/clippy_lints" }
diff --git a/cve-2022-46176-deps/base64-0.13.1/Cargo.toml b/cve-2022-46176-deps/base64-0.13.1/Cargo.toml
index 64179e1aa..ee616084c 100644
--- a/cve-2022-46176-deps/base64-0.13.1/Cargo.toml
+++ b/cve-2022-46176-deps/base64-0.13.1/Cargo.toml
@@ -31,22 +31,6 @@ categories = ["encoding"]
 license = "MIT/Apache-2.0"
 repository = "https://github.com/marshallpierce/rust-base64"
 
-[profile.bench]
-debug = true
-
-[[bench]]
-name = "benchmarks"
-harness = false
-
-[dev-dependencies.criterion]
-version = "=0.3.2"
-
-[dev-dependencies.rand]
-version = "0.6.1"
-
-[dev-dependencies.structopt]
-version = "0.3"
-
 [features]
 alloc = []
 default = ["std"]
diff --git a/cve-2022-46176-deps/hmac-0.12.1/Cargo.toml b/cve-2022-46176-deps/hmac-0.12.1/Cargo.toml
index ca1c001a3..b8f71503a 100644
--- a/cve-2022-46176-deps/hmac-0.12.1/Cargo.toml
+++ b/cve-2022-46176-deps/hmac-0.12.1/Cargo.toml
@@ -27,29 +27,6 @@ rustdoc-args = ["--cfg", "docsrs"]
 [dependencies.digest]
 version = "0.10.3"
 features = ["mac"]
-[dev-dependencies.digest]
-version = "0.10"
-features = ["dev"]
-
-[dev-dependencies.hex-literal]
-version = "0.2.2"
-
-[dev-dependencies.md-5]
-version = "0.10"
-default-features = false
-
-[dev-dependencies.sha-1]
-version = "0.10"
-default-features = false
-
-[dev-dependencies.sha2]
-version = "0.10"
-default-features = false
-
-[dev-dependencies.streebog]
-version = "0.10"
-default-features = false
-
 [features]
 reset = []
 std = ["digest/std"]
diff --git a/cve-2022-46176-deps/sha-1-0.10.1/Cargo.toml b/cve-2022-46176-deps/sha-1-0.10.1/Cargo.toml
index 27698d988..1fbe23473 100644
--- a/cve-2022-46176-deps/sha-1-0.10.1/Cargo.toml
+++ b/cve-2022-46176-deps/sha-1-0.10.1/Cargo.toml
@@ -44,17 +44,9 @@ name = "sha1"
 version = "1.0"
 
 [dependencies.digest]
-version = "0.10.4"
-
-[dev-dependencies.digest]
-version = "0.10.4"
-features = ["dev"]
-
-[dev-dependencies.hex-literal]
-version = "0.2.2"
+version = "0.10"
 
 [features]
-asm = ["sha1-asm"]
 compress = []
 default = ["std"]
 force-soft = []
@@ -63,7 +55,3 @@ std = ["digest/std"]
 
 [target."cfg(any(target_arch = \"aarch64\", target_arch = \"x86\", target_arch = \"x86_64\"))".dependencies.cpufeatures]
 version = "0.2"
-
-[target."cfg(any(target_arch = \"aarch64\", target_arch = \"x86\", target_arch = \"x86_64\"))".dependencies.sha1-asm]
-version = "0.5"
-optional = true
-- 
2.34.1

